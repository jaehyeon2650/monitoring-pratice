# Loki 설정 개념 정리

이 문서는 `config.yml`에서 자주 등장하는 Loki의 주요 개념을 설명합니다.  
처음 보는 분들도 이해할 수 있도록 **데이터 저장과 관리 흐름**을 위주로 정리했습니다.

---

## 1. Ring
- **개념**: Loki는 여러 인스턴스로 확장(클러스터링)할 수 있는데, 각 인스턴스가 어떤 데이터를 책임질지 관리하는 구조가 필요합니다.
- **Ring**은 각 인스턴스의 역할(데이터 저장, 읽기)을 정해주는 **전화번호부 같은 지도**라고 생각하면 됩니다.
- 단일 노드에서는 크게 필요 없으므로 `inmemory`로만 설정합니다. (클러스터가 아닌 1개 서버라면 그냥 메모리에만 저장)

---

## 2. 로그 청크 (Chunk)
- **개념**: Loki는 로그를 한 줄씩 저장하지 않고, 일정 시간이나 크기 단위로 묶어서 저장합니다. 이 묶음을 **청크(Chunk)**라고 합니다.
- **이유**: 청크 단위로 저장하면 검색 속도가 빨라지고 저장 공간 효율도 높아집니다.
- **관련 설정**
    - `chunk_idle_period`: 로그가 안 들어오면 이 시간 후 청크를 닫음 (예: 5분)
    - `max_chunk_age`: 청크가 아무리 길어져도 이 시간이 지나면 강제로 닫음 (예: 1시간)

---

## 3. TSDB (Time Series Database)
- **개념**: 시간(time)을 기준으로 데이터를 저장하는 DB입니다.
- Loki는 로그도 결국 시간 순서대로 쌓이므로 TSDB 구조를 사용합니다.
- TSDB는 **인덱스와 청크를 함께 관리**하여 빠른 조회를 지원합니다.

---

## 4. 인덱스 (Index)
- **개념**: "어떤 로그가 어디 청크에 있는지"를 기록한 **찾아보기 책갈피**입니다.
- 로그 자체는 `chunks`에 저장되며, 인덱스에는 **라벨(job, instance 등)과 로그 위치 정보**가 기록됩니다.
- 인덱스를 통해 Loki는 원하는 로그를 빠르게 찾아낼 수 있습니다.

---

## 5. 인덱스 롤오버 (Index Rollover)
- **개념**: 인덱스를 무한히 하나에 쌓으면 너무 커져서 관리가 어렵습니다.
- 일정 주기마다 인덱스를 새로 시작하는데, 이를 **롤오버(Rollover)**라고 합니다.
- **예시**:
    - `period: 24h` → 하루마다 새로운 인덱스 파일을 생성하여 관리

---

## 6. Loki 스키마 (Schema)
- **개념**: Loki가 데이터를 저장하고 관리하는 방식을 정의한 규칙 모음입니다.
- **예시**:
    - `schema: v11` → 스키마 버전
    - `store: tsdb` → 로그를 TSDB 방식으로 저장
    - `object_store: filesystem` → AWS S3 같은 외부 저장소 대신 로컬 파일시스템 사용

---

## 7. 데이터 보존 (Retention)
- Loki는 무한히 로그를 저장하지 않고, 보존 주기를 설정할 수 있습니다.
- **예시**:
    - `retention_period: 720h` → 720시간(=30일) 동안 로그 보관
    - 이후의 로그는 자동 삭제

---

## Loki 데이터 저장 흐름 요약
1. **Promtail**이 로그를 수집해 Loki로 전송
2. **Loki**는 받은 로그를 **청크(Chunk)** 단위로 묶음
3. 청크가 저장되면, 그 위치를 **인덱스(Index)**에 기록
4. TSDB 구조로 시간 순서대로 데이터를 효율적으로 저장
5. 일정 주기마다 **인덱스 롤오버** 발생 → 관리 용이
6. **Retention 정책**에 따라 오래된 로그는 삭제

---
